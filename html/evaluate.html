<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-param" content="_csrf-frontend">
    <meta name="csrf-token" content="9KbQKGBaz3NrMQ3liXwYWk6WkgEf5raA6c-6coqnME3PMcFVP092_qbGqN2tYGypDTzSB-2Zhr074Le4DZpLng==">
    <link rel='icon' href='../img/icon.png' type='image/x-ico' />
    <link rel="stylesheet" href="../css/base.css?version=2.6.0">
    <title>Đánh giá</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112306571-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-112306571-1');
    </script>
    <script src="../js/jquery.js?version=2.6.0"></script>
    <script src="../js/md5.js?version=2.6.0"></script>
    <script src="../js/require2.3.5.min.js?version=2.6.0"></script>
    <style>
        .body {
            border-top: 1px solid #72aef0;
        }

        .body__main-item {
            float: left;
            width: 100%;
            margin-bottom: 25px;
        }

        .body__main-row1 {
            float: left;
            padding-top: 40px;
            margin-bottom: 30px;
        }

        .body__m-r1-img {
            float: left;
            height: 80px;
            width: 80px;
            border: 1px solid #AFE9FF;
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
        }

        .body__m-r1-desc {
            float: left;
            width: 500px;
            line-height: 1.5;
            padding-top: 15px;
            padding-left: 15px;
            display: -webkit-box;
            overflow: hidden;
            text-overflow: ellipsis;
            word-wrap: break-word;
            white-space: normal !important;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .body__m-r1-d-title {
            color: #666;
            margin-bottom: 5px;
        }

        .body__m-r1-d-price {
            color: #666;
            font-weight: 700;
        }

        .body__m-r1-describe {
            float: left;
            width: 620px;
            padding-left: 80px;
            padding-top: 10px;
        }

        .body__m-r1-d-top {
            float: left;
            width: 320px;
            color: #777;
            margin-bottom: 10px;
            padding-left: 5px;
        }

        .body__m-r1-d-bottom {
            float: left;
            width: 100%;
        }

        .body__m-r1-d-b-start {
            float: left;
            width: 170px;
            font-size: 0;
        }

        .body__m-r1-d-b-s-item {
            height: 20px;
            width: 30px;
            /*padding-right: 6px;*/
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            background-image: url(../img/384787.png);
        }

        .body__m-r1-d-b-s-item.body__m-r1-d-b-s-item_active {
            background-image: url(../img/384788.png);
        }

        .body__m-r1-d-b-text {
            float: left;
            line-height: 20px;
            color: #F76500;
            font-size: 16px;
        }

        .body__main-row2 {
            float: left;
            width: 1200px;
            padding: 5px;
            border: 1px solid #e8e8e8;
            border-radius: 3px;
            margin-bottom: 40px;
        }

        .body__m-r2-textarea {
            float: left;
            display: block;
            width: 100%;
            height: 100px;
            padding: 5px;
            line-height: 1.5;
        }

        .body__main-pic {
            float: left;
            width: 900px;
            margin-bottom: 5px;
            padding-left: 5px;
        }

        .body__main-pic-item {
            float: left;
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px solid #e8e8e8;
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            margin-right: 15px;
        }

        .body__m-p-i-del {
            position: absolute;
            top: -8px;
            right: -8px;
            height: 20px;
            width: 20px;
            z-index: 10;
            cursor: pointer;
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            background-image: url(../img/9344683.png);
        }

        .body__main-pic-file {
            display: none;
        }

        .body__main-pic-add {
            float: left;
            display: block;
            width: 100px;
            height: 100px;
            border-radius: 3px;
            border: 1px solid #e8e8e8;
            text-align: center;
            padding-top: 20px;
            cursor: pointer;
        }

        .body__main-pic-add:active {
            background-color: #ddd;
        }

        .body__m-p-a-icon {
            height: 35px;
            width: 35px;
            margin-bottom: 10px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            background-image: url(../img/2848612.png);
        }

        .body__m-p-a-num {
            color: #999;
        }

        .body__m-r2-tips {
            float: left;
            width: 270px;
            text-align: right;
            color: #ccc;
            margin-top: 80px;
        }

        .body__m-r2-t-num {
            color: #E96F94;
        }

        .body__main-row3 {
            float: left;
            width: 1200px;
            margin-bottom: 30px;
        }

        .body__m-r3-title {
            float: left;
            width: 150px;
            color: #666;
            line-height: 20px;
        }

        .body__m-r3-star {
            float: left;
            width: 1050px;
        }

        .body__main-row4 {
            float: left;
            width: 1200px;
            margin-bottom: 30px;
        }

        .body__m-r4-title {
            float: left;
            width: 150px;
            color: #666;
            line-height: 20px;
        }

        .body__m-r4-star {
            float: left;
            width: 1050px;
        }

        .body__main-row5 {
            float: left;
            width: 1200px;
            margin-bottom: 50px;
            text-align: right;
            font-size: 0;
        }

        .body__m-r5-button {
            line-height: 45px;
            width: 250px;
            background-color: #147af3;
            color: #fff;
            border-radius: 3px;
            text-align: center;
            font-size: 14px;
        }

        .body__m-r5-button:hover {
            background-color: #045ae3;
        }

        .body__m-r5-operate {
            margin-right: 15px;
            line-height: 45px;
        }

        .body__m-r5-o-check {
            font-size: 16px;
            margin-right: 10px;
        }

        .body__m-r5-o-text {
            font-size: 14px;
        }

        .body__main-row6 {
            float: left;
            width: 100%;
            height: 5px;
            background-color: #f5f5f5;
            margin-bottom: 10px;
        }

        .footer {
            float: left;
        }

        .footer:after {
            display: block;
            content: "";
            clear: both;
            height: 0;

        }
    </style>
</head>

<body>
    <div class="mask" id="mask"></div>
    <div class="content" id="vue-el">
        <header class="header" id="header"></header>
        <section class="body col-xs-24">
            <div class="body__main" :style="{ 'min-height': body__main_height + 'px' }">
                <div class="body__main-item" v-for="(val, key) in LS__data">
                    <div class="body__main-row1">
                        <div class="body__m-r1-img" :style="{ 'background-image': 'url(' + val.details.iconUrl + ')' }"></div>
                        <div class="body__m-r1-desc">
                            <div class="body__m-r1-d-title" v-html="val.details.name"></div>
                            <div class="body__m-r1-d-price" v-html="val.details.totalAmount + ' VND'"></div>
                        </div>
                        <div class="body__m-r1-describe">
                            <div class="body__m-r1-d-top">Khớp với mô tả</div>
                            <div class="body__m-r1-d-bottom">
                                <div class="body__m-r1-d-b-start">
                                    <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': val.star_index > 0 }" @click="star_event('click', key, 0)"
                                        @mouseout="star_event('mouseout', key, 0)" @mouseover="star_event('mouseover', key, 0)"></span>
                                    <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': val.star_index > 1}" @click="star_event('click', key, 1)"
                                        @mouseout="star_event('mouseout', key, 1)" @mouseover="star_event('mouseover', key, 1)"></span>
                                    <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': val.star_index > 2 }" @click="star_event('click', key, 2)"
                                        @mouseout="star_event('mouseout', key, 2)" @mouseover="star_event('mouseover', key, 2)"></span>
                                    <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': val.star_index > 3 }" @click="star_event('click', key, 3)"
                                        @mouseout="star_event('mouseout', key, 3)" @mouseover="star_event('mouseover', key, 3)"></span>
                                    <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': val.star_index > 4 }" @click="star_event('click', key, 4)"
                                        @mouseout="star_event('mouseout', key, 4)" @mouseover="star_event('mouseover', key, 4)"></span>
                                </div>
                                <div class="body__m-r1-d-b-text" v-if="describe_star_text[val.star_index - 1] !== undefined" v-html="val.star_index + ' điểm ' + describe_star_text[val.star_index - 1]"></div>
                            </div>
                        </div>
                    </div>
                    <div class="body__main-row2">
                        <textarea class="body__m-r2-textarea" placeholder="Xin vui lòng bình luận" maxlength="500" v-model="val.content"></textarea>
                        <div class="body__main-pic">
                            <li class="body__main-pic-item" :style="{ 'background-image': 'url(' + val1 + ')' }" v-for="(val1, key1) in val.pics">
                                <span class="body__m-p-i-del" @click="pics_del(key, key1)"></span>
                            </li>
                            <input type="file" name="upfile" class="body__main-pic-file" v-bind="{ id: 'body__main-pic-file'+key }" @change="file_selected(key)">
                            <label class="body__main-pic-add" v-bind="{ for: 'body__main-pic-file'+key }" v-show="val.pics.length < 5">
                                <span class="body__m-p-a-icon"></span>
                                <div class="body__m-p-a-num" v-html="val.pics.length + ' / 5'"></div>
                            </label>
                        </div>
                        <div class="body__m-r2-tips"> Có thể nhập
                            <span class="body__m-r2-t-num" v-html="500 - val.content.length"></span> ký tự nữa</div>
                    </div>
                    <div class="body__main-row6"></div>
                </div>
                <!-- <div class="body__main-row3">
                    <div class="body__m-r3-title">Dịch vụ vận chuyển</div>
                    <div class="body__m-r3-star">
                        <div class="body__m-r1-d-bottom">
                            <div class="body__m-r1-d-b-start">
                                <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': logistics_star_index > 0 }" @click="star_event('click', 'logistics')"
                                    @mouseout="star_event('mouseout', 'logistics', 0)" @mouseover="star_event('mouseover', 'logistics', 0)"></span>
                                <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': logistics_star_index > 1}" @click="star_event('click', 'logistics')"
                                    @mouseout="star_event('mouseout', 'logistics', 1)" @mouseover="star_event('mouseover', 'logistics', 1)"></span>
                                <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': logistics_star_index > 2 }" @click="star_event('click', 'logistics')"
                                    @mouseout="star_event('mouseout', 'logistics', 2)" @mouseover="star_event('mouseover', 'logistics', 2)"></span>
                                <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': logistics_star_index > 3 }" @click="star_event('click', 'logistics')"
                                    @mouseout="star_event('mouseout', 'logistics', 3)" @mouseover="star_event('mouseover', 'logistics', 3)"></span>
                                <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': logistics_star_index > 4 }" @click="star_event('click', 'logistics')"
                                    @mouseout="star_event('mouseout', 'logistics', 4)" @mouseover="star_event('mouseover', 'logistics', 4)"></span>
                            </div>
                            <div class="body__m-r1-d-b-text">{{ logistics_star_index }} điểm {{ describe_star_text[logistics_star_index - 1] }}</div>
                        </div>
                    </div>
                </div>
                <div class="body__main-row4">
                    <div class="body__m-r4-title">Thái độ phục vụ</div>
                    <div class="body__m-r4-star">
                        <div class="body__m-r1-d-bottom">
                            <div class="body__m-r1-d-b-start">
                                <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': service_star_index > 0 }" @click="star_event('click', 'service')"
                                    @mouseout="star_event('mouseout', 'service', 0)" @mouseover="star_event('mouseover', 'service', 0)"></span>
                                <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': service_star_index > 1}" @click="star_event('click', 'service')"
                                    @mouseout="star_event('mouseout', 'service', 1)" @mouseover="star_event('mouseover', 'service', 1)"></span>
                                <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': service_star_index > 2 }" @click="star_event('click', 'service')"
                                    @mouseout="star_event('mouseout', 'service', 2)" @mouseover="star_event('mouseover', 'service', 2)"></span>
                                <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': service_star_index > 3 }" @click="star_event('click', 'service')"
                                    @mouseout="star_event('mouseout', 'service', 3)" @mouseover="star_event('mouseover', 'service', 3)"></span>
                                <span class="body__m-r1-d-b-s-item" :class="{ 'body__m-r1-d-b-s-item_active': service_star_index > 4 }" @click="star_event('click', 'service')"
                                    @mouseout="star_event('mouseout', 'service', 4)" @mouseover="star_event('mouseover', 'service', 4)"></span>
                            </div>
                            <div class="body__m-r1-d-b-text">{{ service_star_index }} điểm {{ describe_star_text[service_star_index - 1] }}</div>
                        </div>
                    </div>
                </div> -->
                <div class="body__main-row5">
                    <span class="body__m-r5-operate">
                        <input type="checkbox" class="body__m-r5-o-check" id="body__m-r5-o-check" checked disabled>
                        <label class="body__m-r5-o-text" for="body__m-r5-o-check">Bình luận ẩn danh</label>
                    </span>
                    <span class="body__m-r5-button" @click="submit"> Để lại bình luận</span>
                </div>
            </div>
        </section>
        <footer class="footer" id="footer"></footer>
    </div>
    <script>
        require([
            '../js/jquery1.11.2.js?version=2.6.0',
            '../js/vue.min.js?version=2.6.0',
            '../js/md5.js?version=2.6.0',
            '../js/image-compressor.min.js?version=2.6.0',
            '../js/common.js?version=2.6.0',
        ], function ($, Vue, md5, ImageCompressor) {
            var loading = new F._loading();

            // 很满意, 满意, 一般, 不满意, 很不满意
            F.query = F._hrefUtils.parse().query;
            F.is_submit = false;


            F.vue = {
                body__main_height: document.documentElement.clientHeight - 133 - 210,
                describe_star_text: ['Rất không hài lòng', 'Không hài lòng', 'Bình thường', 'Hài lòng', 'Rất hài lòng'],

                LS__data: [],

                describe_star_index: 0,
                describe_star_index_before: 0,
                describe_star_onclick: false,

                logistics_star_index: 0,
                logistics_star_index_before: 0,
                logistics_star_onclick: false,

                service_star_index: 0,
                service_star_index_before: 0,
                service_star_onclick: false,

                pics: [],

                subject: F.query.subject,
                imgUrl: F.query.imgUrl,
                MO__content: '',
                allow_words: 500,
            };

            var load = function () {
                new_vue();
            };

            var pre_data = function (data) {
                var findOrderDetails = data._trade_findOrderDetails;
                F.vue.LS__data = edit_LS__data(findOrderDetails.goodsDetail);
            }

            F.loadData = function (params, callback) {
                if (callback === undefined) callback = params;

                var all_data = {};
                var request_length = 1; //请求个数

                // 请求是否全部返回
                function all_loaded() {
                    if (Object.keys(all_data).length === request_length) {
                        pre_data(all_data);
                        loading.hide();
                        callback(all_data);
                    }
                }
                loading.show();

                loadData_trade_queryOrder(function (ret) {
                    all_data._trade_findOrderDetails = ret;
                    all_loaded();
                });
            };

            function new_vue() {
                F.vue = new Vue({
                    el: $('#vue-el')[0],
                    data: F.vue,
                    methods: {
                        gohome: gohome,
                        star_event: star_event,
                        pics_del: pics_del,
                        file_selected: file_selected,
                        submit: submit,
                    },
                    computed: {

                    },
                    watch: {
                        MO__content: function (val, oldVal) {
                            this.allow_words = 500 - val.length;
                        }
                    }
                });
            }

            function loadData_trade_findOrderDetails(callback) {
                F._findOrderDetails({
                    orderno: F.query.orderNo,
                    tradeno: F.query.tradeNo,
                }, function (ret) {
                    if (!ret) return false;
                    if (ret.code !== 10000) return false;
                    callback(ret);
                });
            }

            function loadData_trade_queryOrder(callback) {
                F._queryOrder({
                    orderNo: F.query.orderNo,
                    tradeNo: F.query.tradeNo,
                }, function (ret) {
                    if (!ret) return false;
                    if (ret.code !== 10000) return false;
                    callback(ret);
                });
            }

            function edit_LS__data(array) {
                var result = [];
                for (let index = 0; index < array.length; index++) {
                    var item = {
                        star_index: 0,
                        before_star_index: 0,
                        content: '',
                        pics: [],
                        is_onclick: false,
                    };
                    item.details = array[index];
                    result.push(item);
                }
                return result;
            }

            function star_event(event, key, index) {
                switch (event) {
                    case 'click':
                        var item = F.vue.LS__data[key];
                        item.is_onclick = true;
                        item.star_index = index + 1;
                        F.vue.LS__data.splice(key, 1, item);
                        break;

                    case 'mouseover':
                        var item = F.vue.LS__data[key];
                        item.star_index = index + 1;
                        F.vue.LS__data.splice(key, 1, item);
                        break;

                    case 'mouseout':
                        var item = F.vue.LS__data[key];
                        if (item.is_onclick) {
                            item.before_star_index = item.star_index;
                        } else {
                            item.star_index = item.before_star_index;
                        }
                        item.is_onclick = false;
                        F.vue.LS__data.splice(key, 1, item);
                        break;

                    default:
                        // TODO
                        break;
                }
            }

            function pics_del(key, key1) {
                var item = F.vue.LS__data[key];
                item.pics.splice(key1, 1);
                F.vue.LS__data.splice(key, 1, item);
            }

            function gohome() {
                window.location.href = '../index.html';
            }

            function file_selected(key) {
                var file = $('.body__main-pic-file')[key].files[0];
                if (!file) return false;
                loading.show();
                
                new ImageCompressor(file, {
                    quality: .2,
                    success(result) {
                        var fd = new FormData();
                        fd.append("productid", 1); //上传的参数名 参数值 k-v键值对
                        fd.append("files", result, result.name); //上传的文件file

                        F._collectFiles(fd, function (ret) {
                            loading.hide();
                            if (ret.code !== 10000) return false;

                            var item = F.vue.LS__data[key];
                            item.pics.push(ret.url);
                            F.vue.LS__data.splice(key, 1, item);

                        });
                    },
                    error(e) {
                        // console.log(e.message);
                    },
                });

            }

            function submit() {
                if (F.is_submit) {
                    F._confirm('Gợi ý', 'Đừng gửi lại', 'tips', [{
                        name: 'Xác nhận',
                        func: function () {

                        }
                    }]);

                    return false;
                }

                var index;
                var array = F.vue.LS__data;
                for (index = 0; index < array.length; index++) {
                    if (array[index].star_index === 0) {
                        F._confirm('Gợi ý', 'Vui lòng chọn mô tả phù hợp với cấp bậc', 'tips', [{
                            name: 'Xác nhận',
                            func: function () {

                            }
                        }]);
                        return false;
                    }

                    if (array[index].content.length <= 0) {
                        F._confirm('Gợi ý', 'Xin vui lòng bình luận', 'tips', [{
                            name: 'Xác nhận',
                            func: function () {

                            }
                        }]);
                        return false;
                    }
                }

                function edit_comments(array) {
                    var index;
                    var result = [];
                    for (index = 0; index < array.length; index++) {
                        var item = {};
                        item.brand_id = array[index].details.brandId;
                        item.image_urls = array[index].pics.join('|');
                        item.content = array[index].content;
                        item.score = array[index].before_star_index;
                        result.push(item);
                    }
                    return result;
                }


                loading.show();
                // return false;
                F._addEvaluation({
                    msisdn: localStorage.getItem("msisdn"),
                    orderNo: F.query.orderNo,
                    tradeNo: F.query.tradeNo,
                    comments: JSON.stringify(edit_comments(F.vue.LS__data)),
                }, function (ret) {
                    loading.hide();
                    if (!ret) return false;
                    if (ret.code !== 10000) return false;

                    window.location.href = './successeValuate.html';

                });
            }

            F.loadData(function () {
                load();
            });
        });
    </script>
    <script src="https://s22.cnzz.com/z_stat.php?id=1271691056&web_id=1271691056" language="JavaScript"></script>
</body>

</html>